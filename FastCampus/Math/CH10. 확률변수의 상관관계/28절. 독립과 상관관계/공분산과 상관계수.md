# 공분산과 상관계수

두 개 이상의 서로 관련을 가지는 자료 값의 집합들이나 혹은 확률변수들의 관계 즉, 결합 분포는 heatmap과 같은 서술 통계 방법으로 묘사하거나 결합 확률 분포를 사용하여 정의한다.

다변수 확률 변수도 단변수의 경우처럼 평균, 분산과 같은 대표값을 가질 수 있다. 그 중 가장 중요한 것이 자료 간의 상관 관계를 나타내는 공분산(covariance)과 상관계수(correlation coefficient)이다. 공분산과 상관계수도 샘플 자료 집합에 대해 정의되는 샘플 공분산, 샘플 상관계수와 확률 변수에 대해 정의되는 공분산, 상관계수가 있다.



### 샘플 공분산

샘플 공분산(sample covariance)은 다음과 같이 정의된다. 여기에서 $x_i$ 와 $y_i$ 는 각각  $i$번째의 $x$ 자료와 $y$자료의 값을 가리키고, $m_x$와 $m_y$는 $x$ 자료와 $y$ 자료의 샘플 평균을 가리킨다.

샘플 공분산(sample covariance) $$\rightarrow s_{xy} = \dfrac{1}{N}\sum_{i=1}^{N} (x_i-m_x)(y_i-m_y)$$

샘플 분산과 마찬가지로 샘플 공분산도 자료가 평균값으로부터 얼마나 떨어져 있는지를 나타낸 것이다. 공분산은 평균값 위치와 샘플 위치를 연결하는 사각형의 면적을 사용한다. 다만 공분산의 경우에는 자료의 위치에 따라 이 값의 부호가 달라진다. 

![샘플공분산](../../math_img/샘플공분산.png)

위 그림에서 보듯이 공분산은 결합 분포의 평균을 중심으로 각 자료들이 어떻게 분포되어 있는지를 보여준다.

자료가 1사분면과 3사분면에 있는 경우 즉, 같은 부호를 가지는 경우에는 양의 방향으로 값이 커지고 자료가 2사분면이나 4사분면에 있는 경우에는 값의 부호가 음수가 된다.

따라서 공분산의 부호는 자료가 같은 부호를 가지는지 다른 부호를 가지는지에 대한 일종의 방향성을 제시한다고 볼 수 있다.



### 샘플 상관계수

샘플 공분산은 평균을 중심으로 각 자료들이 어떻게 분포되어 있는지 크기와 방향성을 같이 보여준다. 그런데 분포의 크기는  공분산이 아닌 분산으로도 알 수 있기 때문에 대부분의 경우 자료 분포의 방향성만 분리하여 보는 것이 유용하다.

이 때 필요한 것이 **샘플 상관계수(sample correlation coefficient)** 이다.

샘플 상관계수는 다음과 같이 공분산을 각각의 샘플 표준편차값으로 나누어 정규화(normalize)하여 정의한다.

$$r_{xy} = \dfrac{s_{xy}}{\sqrt{s^2_{x} \cdot s^2_{y}}}$$



이와 다르게 정의한 상관계수도 있기 때문에 다른 종류의 상관계수와 비교하여 말하는 경우에는 **피어슨(Pearson) 상관계수** 라고 하기도 한다.



### 확률변수의 공분산과 상관계수

두 확률변수 $X$ 와 $Y$ 의 공분산은 기댓값 연산자를 사용하여 다음과 같이 정의된다.

$$\text{Cov}[X, Y] = \text{E}[(X - \text{E}[X])(Y - \text{E}[Y])]$$



마찬가지로 두 확률변수 $X$ 와 $Y$ 의 상관 계수도 다음과 같이 정의한다.

$$\rho[X,Y] =  \dfrac{\text{Cov}[X, Y]}{\sqrt{\text{Var}[X] \cdot \text{Var}[Y]}}$$



확률변수의 상관계수는 다음과 같은 성질을 가진다.

$$-1\leq \rho \leq 1$$



또한 $\rho 가 -1,0,1$ 인 경우를 각각 다음과 같이 부른다.

- $\rho=1$ : 완전선형 상관관계
- $\rho=0$ : 무상관(독립과는 다음)
- $\rho=-1$ : 완전선형 반상관관계



이 상관관계의 부호와 크기가 의미하는 바는 다음 스캐터플롯에서 알 수 있다. 
스캐터플롯의 데이터가 양의 기울기를 가지는 직선 혹은 타원 모양을 가지면 상관계수는 양수이고, 음의 기울기를 가지는 직선 혹은 타원 모양이 되면 상관계수가 음이 된다. 또한 직선 모양이 뚜렷할수록 상관계수의 절대값이 커지고 원에 가까워질 수록 절대값이 작아진다.

![확률변수 상관 계수](../../math_img/확률변수 상관계수.png)



상관계수로 분포의 형상을 추측할 때 주의할 점은 **개별 자료가 상관계수에 미치는 영향력이 각각 다르다**는 점이다.
다음은 서로 다른 4종류의 2차원 데이터셋을 포함하는데 4종류 데이터셋 모두 상관계수가 약 0.816으로 동일하다.
세번째 데이터셋과 네번째 데이터셋에서 볼 수 있듯이 나머지 데이터의 상관계수가 1 또는 0인 경우에도 단 하나의 특이값 자료에 의해 상관계수가 크게 달라질 수 있다.

![특이값에 따른 상관계수](../../math_img/특이값에 따른 상관계수.png)



### 다변수 확률 변수의 샘플 공분산

이번에는 스칼라가 아닌 벡터 표본값을 가지는 다변수 확률 변수의 공분산에 대해 알아본다.
예를 들어 $M$차원 확률 변수 $x=(x_1,x_2,\cdots,x_M)$ 를 생각하자.
(지금까지는 확률 변수를 대문자로 표시했지만, 여기서는 데이터 행렬과 구분하기 위해 소문자로 표시한다.)
$x_1,x_2,\cdots,x_M$ 각각은 스칼라 확률 변수가 된다.

이 확률 변수의 $N$ 개의 표본 값을 구하면 다음처럼 $N \times M$ 차원의 특징 행렬(feature matrix) $X$ 가 나온다.

$$X = \begin{bmatrix}x_{1, 1} & x_{1, 2} & \cdots   & x_{1, M} \\x_{2, 1} & x_{2, 2} & \cdots   & x_{2, M} \\\vdots   & \vdots   & \ddots   & \vdots   \\x_{N, 1} & x_{N, 2} & \cdots   & x_{N, M} \\\end{bmatrix}$$

이 행렬의 각 열은 각각 확률 변수 $x_1,x_2,\cdots,x_M$ 의 표본이다.
예를 들어 $X$ 행렬의 첫번째 열 $c_1$ 은 확률 변수 $x_1$ 의 표본 데이터이다.

$c_1 =  \begin{bmatrix} x_{1, 1}\\ x_{2, 1}\\ \vdots  \\ x_{N, 1} \end{bmatrix}$



이러한 데이터가 있을 때, 각 확률 변수 $x_j(j=1,\cdots,M)$ 의 기댓값은 다음처럼 계산할 수 있다.

$\text{E}[x_j] = \bar{x}_j = \dfrac{1}{N} \sum_{i=1}^N x_{i,j} = \dfrac{1}{N} \mathbf{1}_N^T c_j = \dfrac{1}{N} c_j^T \mathbf{1}_N$



이 기댓값을 벡터로 모은 기댓값 벡터는 다음처럼 정의한다.

$\bar{x} = \begin{bmatrix}\bar{x}_1 \\\bar{x}_2 \\\vdots  \\\bar{x}_M\\\end{bmatrix}$



이제 각 확률변수 $x_j(j=1,\cdots,M)$ 의 분산은 다음처럼 계산할 수 있다.

$\text{Var}[x_j] = s_j^2 = \dfrac{1}{N} \sum_{i=1}^N (x_{i,j} - \bar{x}_j)^2$



두 확률 변수 $x_j,x_k$ 의 공분산은 다음처럼 구한다.

$\text{Var}[x_j, x_k] = s_{j,k} = \dfrac{1}{N} \sum_{i=1}^N (x_{i,j} - \bar{x}_j)(x_{i,k} - \bar{x}_k)$



모든 확률 변수의 조랍에 대해 분산과 공분산을 구하면 다음처럼 **샘플 공분산 행렬(Sample Covariance Matrix)** 을 정의할 수 있다.



$S =\begin{bmatrix}\begin{eqnarray}s_{x_1}^2     \;\;  &  s_{x_1x_2} \;\;&  s_{x_1x_3} \;\;&  \cdots &  s_{x_1x_M} \\s_{x_1x_2}   \;\;    &  s_{x_2}^2 \;\;&  s_{x_2x_3} \;\;&  \cdots &  s_{x_2x_M} \\\vdots       &  \vdots &  \vdots &  \ddots &  \vdots \\s_{x_1x_M}   \;\;    &  s_{x_2x_M} \;\;&  s_{x_3x_M} \;\;&  \cdots &  s_{x_M}^2 \\\end{eqnarray}\end{bmatrix}$



샘플 공분산 행렬의 실제 계산은 아래와 같이 한다.

$N$ 은 데이터의 갯수이다.

$S = \dfrac{1}{N} X_0^TX_0$



여기에서 $X_0$ 는 평균을 제거하여 샘플 평균이 0이 된 데이터 행렬(zero-mean feature matrix)를 뜻한다.

평균이 제거된 데이터 행렬 $X_0$ 는 다음과 같이 구한다.

$\bar{x} = \dfrac{1}{N} X^T\mathbf{1_N}$

$X_0 = X - \mathbf{1_M}\bar{x}^T = X - \dfrac{1}{N} \mathbf{1_M}\mathbf{1_N}^TX$



### 다변수 확률 변수의 공분산

이론적 공분산 행렬은 $\sum$로 표기하며 다음처럼 정의한다. 이 식에서 확률변수 $X$, 그리고 그 기댓값 $\text{E[X]}$ 는 다변수.
즉, 벡터임에 주의해야한다.

$$\Sigma = \text{Cov}[X] = \text{E} \left[ (X - \text{E}[X])(X - \text{E}[X])^T \right] = \begin{bmatrix} \begin{eqnarray} \sigma_{x_1}^2     \;\;  &  \sigma_{x_1x_2} \;\;&  \sigma_{x_1x_3} \;\;&  \cdots &  \sigma_{x_1x_M} \\ \sigma_{x_1x_2}   \;\;    &  \sigma_{x_2}^2 \;\;&  \sigma_{x_2x_3} \;\;&  \cdots &  \sigma_{x_2x_M} \\ \vdots       &  \vdots &  \vdots &  \ddots &  \vdots \\ \sigma_{x_1x_M}   \;\;    &  \sigma_{x_2x_M} \;\;&  \sigma_{x_3x_M} \;\;&  \cdots &  \sigma_{x_M}^2 \\ \end{eqnarray} \end{bmatrix}$$



































